# Logstash configuration for enrichment services logging
# Collects logs from multiple sources and ships to Elasticsearch

input {
  # TCP input for application logs
  tcp {
    port => 5000
    codec => json
    type => "enrichment_app"
  }

  # UDP input for syslog
  udp {
    port => 5000
    type => "syslog"
  }

  # File input for Docker logs
  file {
    path => "/app/logs/*.log"
    start_position => "beginning"
    codec => json
    type => "enrichment_file"
  }

  # HTTP input for external sources
  http {
    port => 8080
    codec => json
    type => "enrichment_http"
  }
}

filter {
  # Parse JSON if not already parsed
  if [type] == "enrichment_app" or [type] == "enrichment_file" {
    # Already JSON, just add metadata
    mutate {
      add_field => { "source" => "%{[source]}" }
      add_field => { "service" => "enrichment" }
    }
  }

  # Parse syslog messages
  if [type] == "syslog" {
    grok {
      match => { "message" => "%{SYSLOGLINE}" }
    }
  }

  # Add timestamp
  mutate {
    add_field => { "ingestion_time" => "%{@timestamp}" }
  }

  # Extract service name from logger name
  if [logger] {
    grok {
      match => { "logger" => "enrichment_service\.(?<module>[^\.]+)" }
    }
  }

  # Parse error stacks
  if [message] =~ /Traceback|Error|Exception/ {
    mutate {
      add_tag => [ "error" ]
      add_field => { "error_detected" => true }
    }
  }

  # Parse operation names
  if [message] =~ /\[.*\]/ {
    grok {
      match => { "message" => "\[%{DATA:operation}\]" }
    }
  }

  # Add environment tags
  mutate {
    add_field => { "environment" => "${ENVIRONMENT:development}" }
    add_field => { "cluster" => "${CLUSTER:local}" }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["${ELASTICSEARCH_HOSTS:elasticsearch:9200}"]
    index => "enrichment-logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }

  # Also output to console for debugging
  if [@metadata][debug] {
    stdout {
      codec => rubydebug
    }
  }

  # Send errors to separate index
  if "error" in [tags] {
    elasticsearch {
      hosts => ["${ELASTICSEARCH_HOSTS:elasticsearch:9200}"]
      index => "enrichment-errors-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
}
