version: '3.8'

services:
  # ===================== Data Layer =====================

  mongodb:
    image: mongo:7.0
    container_name: enrichment_mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: enrichment_user
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-changeMe123}
      MONGO_INITDB_DATABASE: gvpocr
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - enrichment_network

  # ===================== Message Queue =====================

  nsqlookupd:
    image: nsqio/nsq:latest
    container_name: enrichment_nsqlookupd
    restart: unless-stopped
    ports:
      - "4160:4160"  # TCP
      - "4161:4161"  # HTTP
    command: /nsqlookupd
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4161/api/nodes"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - enrichment_network

  nsqd:
    image: nsqio/nsq:latest
    container_name: enrichment_nsqd
    restart: unless-stopped
    depends_on:
      - nsqlookupd
    ports:
      - "4150:4150"  # TCP
      - "4151:4151"  # HTTP
    command: /nsqd --lookupd-tcp-address=nsqlookupd:4160 --broadcast-address=nsqd
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4151/api/stats"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - enrichment_network

  # ===================== Local LLM (Ollama) =====================

  ollama:
    image: ollama/ollama:latest
    container_name: enrichment_ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    environment:
      OLLAMA_HOST: 0.0.0.0:11434
    volumes:
      - ollama_data:/root/.ollama
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - enrichment_network
    # Note: Run these commands after container starts to load models:
    # docker exec enrichment_ollama ollama pull llama3.2
    # docker exec enrichment_ollama ollama pull mixtral

  # ===================== Monitoring =====================

  prometheus:
    image: prom/prometheus:latest
    container_name: enrichment_prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - ./enrichment_service/utils/prometheus_alerts.yaml:/etc/prometheus/alerts.yaml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - enrichment_network

  grafana:
    image: grafana/grafana:latest
    container_name: enrichment_grafana
    restart: unless-stopped
    depends_on:
      - prometheus
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin123}
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana_provisioning:/etc/grafana/provisioning
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - enrichment_network

  # ===================== MCP Server =====================

  mcp-server:
    build:
      context: ../../mcp-server
      dockerfile: Dockerfile
    container_name: enrichment_mcp_server
    restart: unless-stopped
    depends_on:
      - mongodb
    ports:
      - "3000:3000"
    environment:
      PORT: 3000
      MONGODB_URI: mongodb://enrichment_user:${MONGO_PASSWORD:-changeMe123}@mongodb:27017/gvpocr
      MCP_JWT_SECRET: ${MCP_JWT_SECRET:-your_secret_key_here}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - enrichment_network

  # ===================== MCP Agents =====================

  metadata-agent:
    build:
      context: ../../agents/metadata-agent
      dockerfile: Dockerfile
    container_name: enrichment_metadata_agent
    restart: unless-stopped
    depends_on:
      - mcp-server
      - ollama
    environment:
      MCP_SERVER_URL: ws://mcp-server:3000
      MCP_AGENT_TOKEN: ${MCP_AGENT_TOKEN:-agent_token}
      OLLAMA_HOST: http://ollama:11434
      OLLAMA_MODEL: llama3.2
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - enrichment_network

  entity-agent:
    build:
      context: ../../agents/entity-agent
      dockerfile: Dockerfile
    container_name: enrichment_entity_agent
    restart: unless-stopped
    depends_on:
      - mcp-server
      - ollama
    environment:
      MCP_SERVER_URL: ws://mcp-server:3000
      MCP_AGENT_TOKEN: ${MCP_AGENT_TOKEN:-agent_token}
      OLLAMA_HOST: http://ollama:11434
      OLLAMA_MODEL: llama3.2
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - enrichment_network

  structure-agent:
    build:
      context: ../../agents/structure-agent
      dockerfile: Dockerfile
    container_name: enrichment_structure_agent
    restart: unless-stopped
    depends_on:
      - mcp-server
      - ollama
    environment:
      MCP_SERVER_URL: ws://mcp-server:3000
      MCP_AGENT_TOKEN: ${MCP_AGENT_TOKEN:-agent_token}
      OLLAMA_HOST: http://ollama:11434
      OLLAMA_MODEL: mixtral
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - enrichment_network

  content-agent:
    build:
      context: ../../agents/content-agent
      dockerfile: Dockerfile
    container_name: enrichment_content_agent
    restart: unless-stopped
    depends_on:
      - mcp-server
      - ollama
    environment:
      MCP_SERVER_URL: ws://mcp-server:3000
      MCP_AGENT_TOKEN: ${MCP_AGENT_TOKEN:-agent_token}
      OLLAMA_HOST: http://ollama:11434
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - enrichment_network

  context-agent:
    build:
      context: ../../agents/context-agent
      dockerfile: Dockerfile
    container_name: enrichment_context_agent
    restart: unless-stopped
    depends_on:
      - mcp-server
    environment:
      MCP_SERVER_URL: ws://mcp-server:3000
      MCP_AGENT_TOKEN: ${MCP_AGENT_TOKEN:-agent_token}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      CLAUDE_MODEL: claude-opus-4-5
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - enrichment_network

  # ===================== Enrichment Services =====================

  enrichment-coordinator:
    build:
      context: .
      dockerfile: enrichment_service/Dockerfile.coordinator
    container_name: enrichment_coordinator
    restart: unless-stopped
    depends_on:
      - mongodb
      - nsqd
    environment:
      MONGO_URI: mongodb://enrichment_user:${MONGO_PASSWORD:-changeMe123}@mongodb:27017/gvpocr
      DB_NAME: gvpocr
      NSQD_HOST: nsqd
      NSQD_PORT: 4150
      ENRICHMENT_ENABLED: "true"
      ENRICHMENT_TOPIC: enrichment
      ENRICHMENT_BATCH_SIZE: 50
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "python", "-c", "import enrichment_service; print('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - enrichment_network

  enrichment-worker:
    build:
      context: .
      dockerfile: enrichment_service/Dockerfile.worker
    container_name: enrichment_worker_1
    restart: unless-stopped
    depends_on:
      - mongodb
      - nsqd
      - mcp-server
    environment:
      MONGO_URI: mongodb://enrichment_user:${MONGO_PASSWORD:-changeMe123}@mongodb:27017/gvpocr
      DB_NAME: gvpocr
      NSQD_HOST: nsqd
      NSQD_PORT: 4150
      LOOKUPD_HTTP_ADDRESSES: nsqlookupd:4161
      MCP_SERVER_URL: ws://mcp-server:3000
      ENRICHMENT_TOPIC: enrichment
      ENRICHMENT_CHANNEL: enrichment_worker
      COMPLETENESS_THRESHOLD: 0.95
      MAX_COST_PER_DOC: 0.50
      DAILY_BUDGET_USD: 100.00
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "python", "-c", "import enrichment_service; print('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - enrichment_network

  enrichment-worker-2:
    build:
      context: .
      dockerfile: enrichment_service/Dockerfile.worker
    container_name: enrichment_worker_2
    restart: unless-stopped
    depends_on:
      - mongodb
      - nsqd
      - mcp-server
    environment:
      MONGO_URI: mongodb://enrichment_user:${MONGO_PASSWORD:-changeMe123}@mongodb:27017/gvpocr
      DB_NAME: gvpocr
      NSQD_HOST: nsqd
      NSQD_PORT: 4150
      LOOKUPD_HTTP_ADDRESSES: nsqlookupd:4161
      MCP_SERVER_URL: ws://mcp-server:3000
      ENRICHMENT_TOPIC: enrichment
      ENRICHMENT_CHANNEL: enrichment_worker
      COMPLETENESS_THRESHOLD: 0.95
      MAX_COST_PER_DOC: 0.50
      DAILY_BUDGET_USD: 100.00
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "python", "-c", "import enrichment_service; print('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - enrichment_network

  # ===================== APIs =====================

  review-api:
    build:
      context: .
      dockerfile: enrichment_service/Dockerfile.api
    container_name: enrichment_review_api
    restart: unless-stopped
    depends_on:
      - mongodb
    ports:
      - "5001:5001"
    environment:
      MONGO_URI: mongodb://enrichment_user:${MONGO_PASSWORD:-changeMe123}@mongodb:27017/gvpocr
      DB_NAME: gvpocr
      FLASK_ENV: production
      FLASK_APP: enrichment_service.review.review_api
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - enrichment_network

  cost-api:
    build:
      context: .
      dockerfile: enrichment_service/Dockerfile.api
    container_name: enrichment_cost_api
    restart: unless-stopped
    depends_on:
      - mongodb
    ports:
      - "5002:5002"
    environment:
      MONGO_URI: mongodb://enrichment_user:${MONGO_PASSWORD:-changeMe123}@mongodb:27017/gvpocr
      DB_NAME: gvpocr
      FLASK_ENV: production
      FLASK_APP: enrichment_service.utils.cost_api
      PORT: 5002
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - enrichment_network

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  ollama_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

networks:
  enrichment_network:
    driver: bridge
